<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Shopping List</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 1400px;
            padding: 40px;
            display: grid;
            grid-template-columns: 1fr 350px 1fr;
            gap: 30px;
            max-height: 90vh;
        }

        .chat-section, .list-section, .lists-manager-section {
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .chat-header h1 {
            margin-bottom: 0;
            flex: 1;
        }

        .session-selector {
            position: relative;
        }

        .current-session-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .current-session-btn:hover {
            background: #667eea;
            color: white;
        }

        .session-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-width: 250px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .session-dropdown.show {
            display: block;
        }

        .session-dropdown-header {
            padding: 15px;
            border-bottom: 2px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .new-session-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .new-session-btn:hover {
            transform: translateY(-2px);
        }

        .session-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .session-item:hover {
            background: #f8f9fa;
        }

        .session-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left: 3px solid #667eea;
        }

        .session-info {
            flex: 1;
            min-width: 0;
        }

        .session-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-meta {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }

        .delete-session-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid #dc3545;
            border-radius: 4px;
            color: #dc3545;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .delete-session-btn:hover {
            background: #dc3545;
            color: white;
        }

        .rename-session-input {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            min-height: 400px;
            max-height: 500px;
        }

        .message {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            padding: 12px 18px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            border: 2px solid #e0e0e0;
            color: #333;
            line-height: 1.6;
        }

        .message.assistant .message-content strong {
            color: #667eea;
            font-weight: 700;
        }

        .message.assistant .message-content ul {
            list-style: none;
            margin: 10px 0;
            padding-left: 0;
        }

        .message.assistant .message-content li {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }

        .message.assistant .message-content li:before {
            content: "üîπ";
            position: absolute;
            left: 0;
        }

        .message.system .message-content {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .chat-input-section {
            display: flex;
            gap: 10px;
        }

        #chatInput {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        #chatInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #sendBtn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #sendBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #sendBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .shopping-list {
            flex: 1;
            overflow-y: auto;
            max-height: 560px;
        }

        .list-item {
            background: #f8f9fa;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .list-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .item-quantity {
            font-size: 14px;
            color: #666;
            margin-top: 2px;
        }

        .item-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .control-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #f0f0f0;
            border-color: #999;
            transform: scale(1.05);
        }

        .control-btn.delete-btn {
            color: #dc3545;
            border-color: #dc3545;
        }

        .control-btn.delete-btn:hover {
            background: #dc3545;
            color: white;
        }

        .control-btn.plus-btn {
            color: #28a745;
            border-color: #28a745;
        }

        .control-btn.plus-btn:hover {
            background: #28a745;
            color: white;
        }

        .control-btn.minus-btn {
            color: #ffc107;
            border-color: #ffc107;
        }

        .control-btn.minus-btn:hover {
            background: #ffc107;
            color: white;
        }

        .qty-display {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            flex: 1;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .lists-manager {
            flex: 1;
            overflow-y: auto;
            max-height: 560px;
        }

        .list-name-item {
            background: #f8f9fa;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .list-name-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .list-name-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-color: #667eea;
        }

        .list-name-text {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .list-name-item.active .list-name-text {
            color: #667eea;
        }

        .list-name-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        .list-controls {
            display: flex;
            gap: 5px;
        }

        .list-control-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .list-control-btn:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }

        .list-control-btn.rename-btn {
            color: #667eea;
            border-color: #667eea;
        }

        .list-control-btn.rename-btn:hover {
            background: #667eea;
            color: white;
        }

        .list-control-btn.delete-list-btn {
            color: #dc3545;
            border-color: #dc3545;
        }

        .list-control-btn.delete-list-btn:hover {
            background: #dc3545;
            color: white;
        }

        .list-control-btn.save-btn {
            color: #28a745;
            border-color: #28a745;
        }

        .list-control-btn.save-btn:hover {
            background: #28a745;
            color: white;
        }

        .list-control-btn.cancel-btn {
            color: #6c757d;
            border-color: #6c757d;
        }

        .list-control-btn.cancel-btn:hover {
            background: #6c757d;
            color: white;
        }

        .add-list-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        #newListInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        #newListInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #addListBtn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #addListBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #addListBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                max-width: 600px;
            }

            .lists-manager-section {
                order: 2;
            }

            .list-section {
                order: 3;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5rem;
            }
        }

        .config-banner {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
            display: none;
        }

        .config-banner.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-section">
            <div class="chat-header">
                <h1>ü§ñ AI Assistant</h1>
                <div class="session-selector">
                    <button class="current-session-btn" id="currentSessionBtn">
                        <span id="currentSessionName">New Chat</span>
                        <span>‚ñº</span>
                    </button>
                    <div class="session-dropdown" id="sessionDropdown">
                        <div class="session-dropdown-header">
                            <span>Chat Sessions</span>
                            <button class="new-session-btn" id="newSessionBtn">+ New</button>
                        </div>
                        <div id="sessionList"></div>
                    </div>
                </div>
            </div>
            <div id="configBanner" class="config-banner">
                ‚ö†Ô∏è Please configure Azure OpenAI settings in the browser console or update the config in the script.
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-section">
                <input type="text" id="chatInput" placeholder="Tell me what you need to buy..." autocomplete="off">
                <button id="sendBtn">Send</button>
            </div>
        </div>

        <div class="lists-manager-section">
            <h1>üìã My Lists</h1>
            <div class="lists-manager" id="listsManager"></div>
            <div class="add-list-section">
                <input type="text" id="newListInput" placeholder="New list name..." autocomplete="off">
                <button id="addListBtn">Add</button>
            </div>
        </div>

        <div class="list-section">
            <h1>üõí <span id="activeListTitle">Shopping List</span></h1>
            <div class="shopping-list" id="shoppingList"></div>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalItems">0</span>
                    <span class="stat-label">Total Items</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Update these or set via console: app.config.setConfig({...})
        const CONFIG = {
            azureEndpoint: '',
            azureKey: '',
            azureDeployment: ''
        };

        class ShoppingListApp {
            constructor() {
                this.shoppingLists = JSON.parse(localStorage.getItem('shoppingLists')) || [];
                this.activeListId = parseInt(localStorage.getItem('activeListId')) || null;
                this.nextListId = Math.max(0, ...this.shoppingLists.map(l => l.id || 0)) + 1;
                
                // Chat session management
                this.chatSessions = JSON.parse(localStorage.getItem('chatSessions')) || [];
                this.activeSessionId = null;
                this.nextSessionId = Math.max(0, ...this.chatSessions.map(s => s.id || 0)) + 1;
                
                this.config = { ...CONFIG };
                this.pendingItems = null;
                this.init();
            }

            async init() {
                this.cacheElements();
                this.bindEvents();
                
                // Create new session after elements are cached
                this.createNewSession(true);
                
                await this.loadConfig();
                this.checkConfig();
                
                const session = this.getActiveSession();
                if (!session || session.messages.length === 0) {
                    this.addMessage('assistant', "Hi! I'm your AI shopping assistant. Tell me what you need to buy, and I'll help you organize your shopping lists!");
                }
            }

            async loadConfig() {
                try {
                    const response = await fetch('/config');
                    if (response.ok) {
                        const config = await response.json();
                        if (config.azureEndpoint && config.azureKey && config.azureDeployment) {
                            this.config = config;
                            console.log('‚úÖ Azure OpenAI configuration loaded successfully');
                        }
                    }
                } catch (error) {
                    console.warn('Could not load config from server:', error);
                }
            }

            cacheElements() {
                this.chatInput = document.getElementById('chatInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.chatMessages = document.getElementById('chatMessages');
                this.shoppingList = document.getElementById('shoppingList');
                this.totalItems = document.getElementById('totalItems');
                this.configBanner = document.getElementById('configBanner');
                this.listsManager = document.getElementById('listsManager');
                this.newListInput = document.getElementById('newListInput');
                this.addListBtn = document.getElementById('addListBtn');
                this.activeListTitle = document.getElementById('activeListTitle');
                this.currentSessionBtn = document.getElementById('currentSessionBtn');
                this.currentSessionName = document.getElementById('currentSessionName');
                this.sessionDropdown = document.getElementById('sessionDropdown');
                this.newSessionBtn = document.getElementById('newSessionBtn');
                this.sessionList = document.getElementById('sessionList');
            }

            bindEvents() {
                this.sendBtn.addEventListener('click', () => this.handleSend());
                this.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.handleSend();
                    }
                });
                this.addListBtn.addEventListener('click', () => this.handleAddList());
                this.newListInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.handleAddList();
                    }
                });
                
                // Session management events
                this.currentSessionBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.sessionDropdown.classList.toggle('show');
                });
                
                this.newSessionBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.createNewSession();
                    this.sessionDropdown.classList.remove('show');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.session-selector')) {
                        this.sessionDropdown.classList.remove('show');
                    }
                });
            }

            checkConfig() {
                if (!this.config.azureEndpoint || !this.config.azureKey || !this.config.azureDeployment) {
                    this.configBanner.classList.add('show');
                    this.addMessage('system', 'Please configure Azure OpenAI settings. Use: app.config.setConfig({ azureEndpoint: "...", azureKey: "...", azureDeployment: "..." })');
                }
            }

            setConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                if (this.config.azureEndpoint && this.config.azureKey && this.config.azureDeployment) {
                    this.configBanner.classList.remove('show');
                    this.addMessage('system', '‚úÖ Configuration updated successfully!');
                }
            }

            async handleSend() {
                const text = this.chatInput.value.trim();
                if (!text || !this.config.azureEndpoint || !this.config.azureKey) return;

                this.addMessage('user', text);
                this.chatInput.value = '';
                this.sendBtn.disabled = true;
                this.sendBtn.innerHTML = '<span class="loading"></span>';

                try {
                    const response = await this.callAzureOpenAI(text);
                    this.processAIResponse(response);
                } catch (error) {
                    this.addMessage('system', `Error: ${error.message}`);
                } finally {
                    this.sendBtn.disabled = false;
                    this.sendBtn.textContent = 'Send';
                }
            }

            getActiveSession() {
                return this.chatSessions.find(s => s.id === this.activeSessionId);
            }

            createNewSession(isInitial = false) {
                const now = new Date();
                const session = {
                    id: this.nextSessionId++,
                    name: `Chat ${now.toLocaleDateString()} ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
                    messages: [],
                    conversationHistory: [],
                    pendingItems: null,
                    pendingAction: null,
                    createdAt: now.toISOString(),
                    updatedAt: now.toISOString()
                };
                
                this.chatSessions.push(session);
                this.activeSessionId = session.id;
                
                if (!isInitial) {
                    this.addMessage('assistant', "Hi! I'm your AI shopping assistant. Tell me what you need to buy, and I'll help you organize your shopping lists!");
                }
                
                this.saveSessions();
                this.render();
            }

            switchSession(sessionId) {
                const session = this.chatSessions.find(s => s.id === sessionId);
                if (session) {
                    this.activeSessionId = sessionId;
                    this.pendingItems = session.pendingItems;
                    this.render();
                }
            }

            deleteSession(sessionId) {
                if (this.chatSessions.length === 1) {
                    alert('You must have at least one chat session');
                    return;
                }
                
                this.chatSessions = this.chatSessions.filter(s => s.id !== sessionId);
                
                if (this.activeSessionId === sessionId) {
                    this.activeSessionId = this.chatSessions[0].id;
                    this.pendingItems = this.chatSessions[0].pendingItems;
                }
                
                this.saveSessions();
                this.render();
            }

            renameSession(sessionId, newName) {
                const session = this.chatSessions.find(s => s.id === sessionId);
                if (session && newName.trim()) {
                    session.name = newName.trim();
                    session.updatedAt = new Date().toISOString();
                    this.saveSessions();
                    this.render();
                }
            }

            saveSessions() {
                localStorage.setItem('chatSessions', JSON.stringify(this.chatSessions));
            }

            async callAzureOpenAI(userMessage) {
                const activeList = this.getActiveList();
                const allLists = this.shoppingLists.map(l => ({ id: l.id, name: l.name }));
                const session = this.getActiveSession();
                
                const activeListInfo = activeList 
                    ? `{"id": ${activeList.id}, "name": "${activeList.name}", "items": ${JSON.stringify(activeList.items)}}`
                    : 'null';
                
                const activeListName = activeList ? activeList.name : 'a new list';
                const activeListId = activeList ? activeList.id : 'null';
                
                const systemPrompt = `You are a helpful shopping list assistant. Your job is to:
1. Parse natural language requests to add, update, or remove shopping items
2. Extract item names and quantities from user messages
3. When quantities are not specified, ask the user politely
4. BEFORE making ANY changes (add/remove/update), ALWAYS show a preview of what will be done
5. Wait for user confirmation before executing changes
6. If there are no existing shopping lists, suggest creating a new list with a name
7. Respond with JSON in this exact format:

{
  "action": "add|remove|update|clarify|ask_list|preview|confirm",
  "items": [{"name": "item name", "quantity": "2 lbs"}],
  "targetListId": null,
  "targetListName": "optional new list name",
  "message": "friendly response to user",
  "preview": "optional formatted preview of changes"
}

Available shopping lists: ${JSON.stringify(allLists)}
Current active list: ${activeListInfo}

IMPORTANT WORKFLOW:
- When user provides items with quantities, use action "preview" to show what will be done
- Format messages with markdown-style formatting: **bold text** for headers, bullet points (‚Ä¢) for lists
- Use emojis to make messages clear and friendly
- Only use action "add/remove/update" after user confirms (says yes, ok, confirm, etc.)

FORMATTING GUIDELINES:
- Use **Bold Text** for section headers and important labels
- Use bullet points (‚Ä¢) for lists of items
- Include emojis for visual clarity: üìã for list actions, üõí for items, üóëÔ∏è for removals, ‚úÖ for success
- Add blank lines between sections for readability
- Format: "‚Ä¢ Item Name - Quantity" for each item

Examples:
- User: "I need milk and bread" -> {"action": "clarify", "items": [{"name": "milk"}, {"name": "bread"}], "message": "Got it! How much milk and bread do you need?"}

- User: "2 gallons of milk and a loaf of bread" -> {"action": "preview", "items": [{"name": "milk", "quantity": "2 gallons"}, {"name": "bread", "quantity": "1 loaf"}], "message": "Great! Let me show you what I'll do:\n\nüìã **Action:** Create new shopping list\n**List name:** I'll ask you to name it\n\nüõí **Items to add:**\n‚Ä¢ Milk - 2 gallons\n‚Ä¢ Bread - 1 loaf\n\nShould I proceed? Reply **yes** to confirm or **no** to cancel."}

- User: "yes" or "ok" (after preview) -> {"action": "add", "items": [{"name": "milk", "quantity": "2 gallons"}, {"name": "bread", "quantity": "1 loaf"}], "targetListId": ${activeListId}, "targetListName": "Shopping List", "message": "‚úÖ **Done!** Added 2 items to your list."}

- User: "remove milk from my list" -> {"action": "preview", "items": [{"name": "milk"}], "targetListId": ${activeListId}, "message": "I'll remove the following from **${activeListName}**:\n\nüóëÔ∏è **Items to remove:**\n‚Ä¢ Milk\n\nConfirm? Reply **yes** or **no**."}

- User: "yes" (after remove preview) -> {"action": "remove", "items": [{"name": "milk"}], "targetListId": ${activeListId}, "message": "‚úÖ **Removed** milk from ${activeListName}"}

Always respond with valid JSON only.`;

                session.conversationHistory.push({ role: 'user', content: userMessage });

                const apiVersion = this.config.azureApiVersion || '2024-08-01-preview';
                const response = await fetch(`${this.config.azureEndpoint}/openai/deployments/${this.config.azureDeployment}/chat/completions?api-version=${apiVersion}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': this.config.azureKey
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...session.conversationHistory.slice(-6)
                        ],
                        max_completion_tokens: 2000
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Azure API Error:', errorData);
                    throw new Error(`Azure OpenAI API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;
                session.conversationHistory.push({ role: 'assistant', content: assistantMessage });
                session.updatedAt = new Date().toISOString();
                this.saveSessions();

                console.log('AI Response:', assistantMessage);
                
                try {
                    return JSON.parse(assistantMessage);
                } catch (parseError) {
                    console.error('Failed to parse AI response:', assistantMessage);
                    throw new Error('AI returned invalid JSON. Please try again.');
                }
            }

            processAIResponse(response) {
                this.addMessage('assistant', response.message);
                const session = this.getActiveSession();

                switch (response.action) {
                    case 'preview':
                        // Store pending changes for confirmation
                        this.pendingItems = response.items;
                        session.pendingItems = response.items;
                        session.pendingAction = {
                            targetListId: response.targetListId,
                            targetListName: response.targetListName,
                            actionType: response.items ? 'add' : 'other'
                        };
                        this.saveSessions();
                        break;
                    case 'ask_list':
                        this.pendingItems = response.items;
                        session.pendingItems = response.items;
                        this.saveSessions();
                        break;
                    case 'add':
                        const itemsToAdd = response.items || this.pendingItems;
                        if (itemsToAdd) {
                            let targetListId = response.targetListId;
                            
                            // Check if we have pending action data
                            if (session.pendingAction && session.pendingAction.targetListName) {
                                response.targetListName = session.pendingAction.targetListName;
                            }
                            if (session.pendingAction && session.pendingAction.targetListId) {
                                targetListId = session.pendingAction.targetListId;
                            }
                            
                            if (response.targetListName) {
                                const newList = this.createNewList(response.targetListName);
                                targetListId = newList.id;
                                this.setActiveList(targetListId);
                            }
                            
                            if (!targetListId) {
                                targetListId = this.activeListId;
                            }
                            
                            itemsToAdd.forEach(item => {
                                if (item.quantity) {
                                    this.addItemToList(targetListId, item.name, item.quantity);
                                }
                            });
                            this.pendingItems = null;
                            session.pendingItems = null;
                            session.pendingAction = null;
                            this.saveSessions();
                        }
                        break;
                    case 'remove':
                        const listId = response.targetListId || this.activeListId;
                        response.items.forEach(item => {
                            this.removeItemFromList(listId, item.name);
                        });
                        break;
                    case 'update':
                        const updateListId = response.targetListId || this.activeListId;
                        response.items.forEach(item => {
                            this.updateItemInList(updateListId, item.name, item.quantity);
                        });
                        break;
                }

                this.render();
            }

            getActiveList() {
                if (this.shoppingLists.length === 0) return null;
                return this.shoppingLists.find(l => l.id === this.activeListId) || this.shoppingLists[0];
            }

            setActiveList(listId) {
                this.activeListId = listId;
                localStorage.setItem('activeListId', listId);
                this.render();
            }

            createNewList(name) {
                const newList = {
                    id: this.nextListId++,
                    name: name,
                    items: []
                };
                this.shoppingLists.push(newList);
                this.saveLists();
                return newList;
            }

            handleAddList() {
                const name = this.newListInput.value.trim();
                if (!name) return;
                
                const newList = this.createNewList(name);
                this.setActiveList(newList.id);
                this.newListInput.value = '';
                this.render();
            }

            deleteList(listId) {
                this.shoppingLists = this.shoppingLists.filter(l => l.id !== listId);
                
                if (this.shoppingLists.length > 0 && this.activeListId === listId) {
                    this.activeListId = this.shoppingLists[0].id;
                } else if (this.shoppingLists.length === 0) {
                    this.activeListId = null;
                }
                
                this.saveLists();
                this.render();
            }

            renameList(listId, newName) {
                const list = this.shoppingLists.find(l => l.id === listId);
                if (list && newName.trim()) {
                    list.name = newName.trim();
                    this.saveLists();
                    this.render();
                }
            }

            addItemToList(listId, name, quantity) {
                const list = this.shoppingLists.find(l => l.id === listId);
                if (!list) return;
                
                const normalizedQty = this.normalizeQuantity(quantity);
                const existingItem = list.items.find(i => 
                    i.name.toLowerCase() === name.toLowerCase()
                );
                
                const nextId = Math.max(0, ...list.items.map(i => i.id || 0)) + 1;
                
                if (existingItem) {
                    existingItem.quantity = normalizedQty;
                    existingItem.numericQty = this.extractNumericQuantity(normalizedQty);
                } else {
                    list.items.push({
                        id: nextId,
                        name: name,
                        quantity: normalizedQty,
                        numericQty: this.extractNumericQuantity(normalizedQty)
                    });
                }
                this.saveLists();
            }

            extractNumericQuantity(quantity) {
                const match = quantity.match(/^(\d+)/);
                return match ? parseInt(match[1]) : 1;
            }

            normalizeQuantity(quantity) {
                // Handle ranges like "1-10 lbs" -> pick the midpoint
                const rangeMatch = quantity.match(/^(\d+)-(\d+)\s*(.*)$/);
                if (rangeMatch) {
                    const min = parseInt(rangeMatch[1]);
                    const max = parseInt(rangeMatch[2]);
                    const midpoint = Math.round((min + max) / 2);
                    const unit = rangeMatch[3] || '';
                    return `${midpoint} ${unit}`.trim();
                }
                return quantity;
            }

            removeItemFromList(listId, name) {
                const list = this.shoppingLists.find(l => l.id === listId);
                if (!list) return;
                
                list.items = list.items.filter(i => 
                    i.name.toLowerCase() !== name.toLowerCase()
                );
                this.saveLists();
            }

            updateItemInList(listId, name, quantity) {
                const list = this.shoppingLists.find(l => l.id === listId);
                if (!list) return;
                
                const item = list.items.find(i => 
                    i.name.toLowerCase() === name.toLowerCase()
                );
                if (item && quantity) {
                    const normalizedQty = this.normalizeQuantity(quantity);
                    item.quantity = normalizedQty;
                    item.numericQty = this.extractNumericQuantity(normalizedQty);
                    this.saveLists();
                }
            }

            deleteItem(id) {
                const list = this.getActiveList();
                list.items = list.items.filter(i => i.id !== id);
                this.saveLists();
                this.renderList();
            }

            incrementQuantity(id) {
                const list = this.getActiveList();
                const item = list.items.find(i => i.id === id);
                if (item) {
                    item.numericQty = (item.numericQty || 1) + 1;
                    item.quantity = item.quantity.replace(/^\d+/, item.numericQty);
                    this.saveLists();
                    this.renderList();
                }
            }

            decrementQuantity(id) {
                const list = this.getActiveList();
                const item = list.items.find(i => i.id === id);
                if (item && item.numericQty > 1) {
                    item.numericQty -= 1;
                    item.quantity = item.quantity.replace(/^\d+/, item.numericQty);
                    this.saveLists();
                    this.renderList();
                }
            }

            addMessage(role, content) {
                const session = this.getActiveSession();
                if (session) {
                    session.messages.push({ role, content, timestamp: Date.now() });
                    session.updatedAt = new Date().toISOString();
                    this.saveSessions();
                    this.renderMessages();
                }
            }

            render() {
                this.renderMessages();
                this.renderListsManager();
                this.renderList();
                this.renderSessionSelector();
            }

            renderSessionSelector() {
                const session = this.getActiveSession();
                if (session) {
                    this.currentSessionName.textContent = session.name;
                }

                if (this.chatSessions.length === 0) {
                    this.sessionList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No sessions</div>';
                    return;
                }

                this.sessionList.innerHTML = this.chatSessions
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .map(session => {
                        const isActive = session.id === this.activeSessionId;
                        const messageCount = session.messages.length;
                        const lastUpdated = new Date(session.updatedAt);
                        const timeAgo = this.getTimeAgo(lastUpdated);
                        
                        return `
                            <div class="session-item ${isActive ? 'active' : ''}" data-session-id="${session.id}">
                                <div class="session-info">
                                    <div class="session-name" title="${this.escapeHtml(session.name)}">${this.escapeHtml(session.name)}</div>
                                    <div class="session-meta">${messageCount} messages ‚Ä¢ ${timeAgo}</div>
                                </div>
                                <button class="delete-session-btn" data-action="delete" title="Delete session">√ó</button>
                            </div>
                        `;
                    }).join('');

                this.sessionList.querySelectorAll('.session-item').forEach(sessionEl => {
                    const sessionId = parseInt(sessionEl.dataset.sessionId);
                    
                    sessionEl.addEventListener('click', (e) => {
                        if (!e.target.closest('.delete-session-btn')) {
                            this.switchSession(sessionId);
                            this.sessionDropdown.classList.remove('show');
                        }
                    });
                    
                    const deleteBtn = sessionEl.querySelector('.delete-session-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const session = this.chatSessions.find(s => s.id === sessionId);
                            if (confirm(`Delete session "${session.name}"?`)) {
                                this.deleteSession(sessionId);
                            }
                        });
                    }
                });
            }

            getTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                
                if (seconds < 60) return 'just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
                if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
                
                return date.toLocaleDateString();
            }

            renderListsManager() {
                if (this.shoppingLists.length === 0) {
                    this.listsManager.innerHTML = '<div class="empty-state"><p>No lists yet</p></div>';
                    return;
                }

                this.listsManager.innerHTML = this.shoppingLists.map(list => {
                    const isActive = list.id === this.activeListId;
                    const itemCount = list.items.length;
                    
                    return `
                        <div class="list-name-item ${isActive ? 'active' : ''}" data-list-id="${list.id}">
                            <div class="list-name-text">
                                ${this.escapeHtml(list.name)}
                                <span style="font-size: 12px; color: #999; font-weight: normal;"> (${itemCount})</span>
                            </div>
                            <div class="list-controls">
                                <button class="list-control-btn rename-btn" data-action="rename" title="Rename">‚úèÔ∏è</button>
                                <button class="list-control-btn delete-list-btn" data-action="delete" title="Delete">üóë</button>
                            </div>
                        </div>
                    `;
                }).join('');

                this.listsManager.querySelectorAll('.list-name-item').forEach(listEl => {
                    const listId = parseInt(listEl.dataset.listId);
                    
                    listEl.addEventListener('click', (e) => {
                        if (!e.target.closest('.list-controls')) {
                            this.setActiveList(listId);
                        }
                    });
                    
                    listEl.querySelectorAll('.list-control-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const action = btn.dataset.action;
                            
                            if (action === 'rename') {
                                this.startRenameList(listId, listEl);
                            } else if (action === 'delete') {
                                if (confirm(`Delete "${this.shoppingLists.find(l => l.id === listId).name}"?`)) {
                                    this.deleteList(listId);
                                }
                            }
                        });
                    });
                });
            }

            startRenameList(listId, listEl) {
                const list = this.shoppingLists.find(l => l.id === listId);
                if (!list) return;
                
                const currentName = list.name;
                listEl.innerHTML = `
                    <input type="text" class="list-name-input" value="${this.escapeHtml(currentName)}" data-list-id="${listId}">
                    <div class="list-controls">
                        <button class="list-control-btn save-btn" data-action="save">‚úì</button>
                        <button class="list-control-btn cancel-btn" data-action="cancel">‚úï</button>
                    </div>
                `;
                
                const input = listEl.querySelector('.list-name-input');
                input.focus();
                input.select();
                
                const saveRename = () => {
                    const newName = input.value.trim();
                    if (newName && newName !== currentName) {
                        this.renameList(listId, newName);
                    } else {
                        this.render();
                    }
                };
                
                const cancelRename = () => {
                    this.render();
                };
                
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveRename();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelRename();
                    }
                });
                
                listEl.querySelector('[data-action="save"]').addEventListener('click', saveRename);
                listEl.querySelector('[data-action="cancel"]').addEventListener('click', cancelRename);
            }

            renderMessages() {
                const session = this.getActiveSession();
                if (!session || session.messages.length === 0) {
                    this.chatMessages.innerHTML = '<div class="empty-state"><p>Start a conversation...</p></div>';
                    return;
                }

                this.chatMessages.innerHTML = session.messages.map(msg => {
                    const formattedContent = msg.role === 'assistant' 
                        ? this.formatAssistantMessage(msg.content)
                        : this.escapeHtml(msg.content);
                    
                    return `
                        <div class="message ${msg.role}">
                            <div class="message-content">${formattedContent}</div>
                        </div>
                    `;
                }).join('');

                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            formatAssistantMessage(content) {
                // Escape HTML first
                let formatted = this.escapeHtml(content);
                
                // Convert **bold** to <strong>
                formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                
                // Convert bullet points (‚Ä¢ or -) at start of line to proper list items
                const lines = formatted.split('\n');
                let inList = false;
                let result = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Check if line starts with bullet
                    if (line.startsWith('‚Ä¢') || line.match(/^-\s/)) {
                        if (!inList) {
                            result.push('<ul style="margin: 10px 0; padding-left: 20px;">');
                            inList = true;
                        }
                        const itemText = line.replace(/^[‚Ä¢-]\s*/, '');
                        result.push(`<li style="margin: 5px 0;">${itemText}</li>`);
                    } else {
                        if (inList) {
                            result.push('</ul>');
                            inList = false;
                        }
                        if (line) {
                            result.push(line + '<br>');
                        } else {
                            result.push('<br>');
                        }
                    }
                }
                
                if (inList) {
                    result.push('</ul>');
                }
                
                return result.join('');
            }

            renderList() {
                const activeList = this.getActiveList();
                
                if (!activeList) {
                    this.activeListTitle.textContent = 'No List Selected';
                    this.shoppingList.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <p>No shopping lists. Create one to get started!</p>
                        </div>
                    `;
                    this.totalItems.textContent = '0';
                    return;
                }
                
                this.activeListTitle.textContent = activeList.name;
                
                if (activeList.items.length === 0) {
                    this.shoppingList.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <p>Your shopping list is empty</p>
                        </div>
                    `;
                } else {
                    this.shoppingList.innerHTML = activeList.items.map(item => `
                        <div class="list-item" data-id="${item.id}">
                            <div class="item-info">
                                <div class="item-name">${this.escapeHtml(item.name)}</div>
                                <div class="item-quantity">${this.escapeHtml(item.quantity)}</div>
                            </div>
                            <div class="item-controls">
                                <button class="control-btn minus-btn" data-action="minus">‚àí</button>
                                <span class="qty-display">${item.numericQty || 1}</span>
                                <button class="control-btn plus-btn" data-action="plus">+</button>
                                <button class="control-btn delete-btn" data-action="delete">üóë</button>
                            </div>
                        </div>
                    `).join('');
                    
                    // Attach event listeners after rendering
                    this.shoppingList.querySelectorAll('.list-item').forEach(itemEl => {
                        const id = parseFloat(itemEl.dataset.id);
                        
                        itemEl.querySelectorAll('.control-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const action = btn.dataset.action;
                                if (action === 'plus') this.incrementQuantity(id);
                                else if (action === 'minus') this.decrementQuantity(id);
                                else if (action === 'delete') this.deleteItem(id);
                            });
                        });
                    });
                }

                this.updateStats();
            }

            updateStats() {
                const activeList = this.getActiveList();
                this.totalItems.textContent = activeList ? activeList.items.length : 0;
            }

            saveLists() {
                localStorage.setItem('shoppingLists', JSON.stringify(this.shoppingLists));
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        const app = new ShoppingListApp();
        
        // Expose config setter globally for easy setup
        window.app = {
            config: {
                setConfig: (config) => app.setConfig(config)
            }
        };

        console.log('üí° To configure Azure OpenAI, use:');
        console.log('app.config.setConfig({ azureEndpoint: "https://...", azureKey: "...", azureDeployment: "..." })');
    </script>
</body>
</html>
